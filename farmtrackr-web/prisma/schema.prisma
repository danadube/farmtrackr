// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model FarmContact {
  id                 String   @id @default(cuid())
  firstName          String?
  lastName           String?
  organizationName   String? // For businesses, trusts, organizations (separate from farm)
  farm               String?
  mailingAddress     String?
  city               String?
  state              String?
  zipCode            String?
  email1             String?
  email2             String?
  phoneNumber1       String?
  phoneNumber2       String?
  phoneNumber3       String?
  phoneNumber4       String?
  phoneNumber5       String?
  phoneNumber6       String?
  siteMailingAddress String?
  siteCity           String?
  siteState          String?
  siteZipCode        String?
  website            String?
  notes              String?
  dateCreated        DateTime @default(now())
  dateModified       DateTime @updatedAt

  // Relations
  emails EmailLog[]
  listings Listing[] @relation("ListingSeller")

  @@map("farm_contacts")
}

model GeneralContact {
  id                 String   @id @default(cuid())
  firstName          String?
  lastName           String?
  organizationName   String? // For businesses
  tags               String[] // Multi-select tags (e.g., "buyer", "seller", "client", "realtor")
  mailingAddress     String?
  city               String?
  state              String?
  zipCode            String?
  email1             String?
  email2             String?
  phoneNumber1       String?
  phoneNumber2       String?
  phoneNumber3       String?
  phoneNumber4       String?
  phoneNumber5       String?
  phoneNumber6       String?
  siteMailingAddress String?
  siteCity           String?
  siteState          String?
  siteZipCode        String?
  website            String?
  notes              String?
  googleContactsId   String? // Google Contacts resource ID for syncing
  dateCreated        DateTime @default(now())
  dateModified       DateTime @updatedAt

  listings           Listing[] @relation("ListingBuyerClient")

  @@map("general_contacts")
}

model ImportTemplate {
  id           String   @id @default(cuid())
  name         String
  description  String?
  fieldMapping Json // Store field mapping as JSON
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("import_templates")
}

model LabelTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  template    Json // Store template configuration as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("label_templates")
}

model Document {
  id          String   @id @default(cuid())
  title       String   @unique
  description String?
  type        String? // Document type: 'template', 'contact', 'report', or null
  content     String? // Store document content as text
  fileUrl     String? // Store file URL if it's a file
  contactId   String? // Optional link to a contact
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("documents")
}

model LetterTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  content     String // Template content with variables like {{farm}}, {{contact_name}}
  variables   Json? // Available variables as JSON array
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("letter_templates")
}

enum SignatureType {
  SINCERELY
  BEST_REGARDS
  WARMEST_REGARDS
  THANK_YOU
  RESPECTFULLY
  CUSTOM
}

model Signature {
  id        String        @id @default(cuid())
  name      String // Display name for the signature
  type      SignatureType @default(CUSTOM)
  closing   String // Closing text (e.g., "Sincerely,")
  signature String // Signature line (e.g., "John Doe" or "FarmTrackr Team")
  isDefault Boolean       @default(false)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@map("signatures")
}

model Letterhead {
  id          String   @id @default(cuid())
  name        String // Display name for the letterhead
  description String? // Brief description
  headerHtml  String? // HTML content for header (logo, company name, address)
  headerText  String? // Plain text alternative for header
  footerHtml  String? // HTML content for footer (optional)
  footerText  String? // Plain text alternative for footer
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("letterheads")
}

model Transaction {
  id String @id @default(cuid())

  // Basic Info
  propertyType    String // 'Residential', 'Commercial', 'Land', etc.
  clientType      String // 'Buyer', 'Seller'
  transactionType String // 'Sale', 'Referral Out', 'Referral In'
  source          String? // Lead source
  address         String?
  city            String?
  listPrice       Decimal?  @db.Decimal(12, 2)
  closedPrice     Decimal?  @db.Decimal(12, 2)
  listDate        DateTime?
  closingDate     DateTime?
  status          String // 'Closed', 'Pending', 'Cancelled'
  
  // Email Linking (for auto-linking emails)
  clientEmail     String? // Primary email for auto-linking emails
  ccEmails        String[] // Additional emails to auto-link (stored as array)

  // Referral Fields
  referringAgent      String? // Name of agent referred to/from
  referralFeeReceived Decimal? @db.Decimal(10, 2)

  // Commission Fields
  brokerage      String // 'Keller Williams', 'BDH', etc.
  commissionPct  Decimal? @db.Decimal(5, 4) // As decimal (0.0300 = 3%)
  referralPct    Decimal? @db.Decimal(5, 4)
  referralDollar Decimal? @db.Decimal(10, 2)
  netVolume      Decimal? @db.Decimal(12, 2)

  // KW Specific
  eo              Decimal? @db.Decimal(10, 2)
  royalty         Decimal? @db.Decimal(10, 2)
  companyDollar   Decimal? @db.Decimal(10, 2)
  hoaTransfer     Decimal? @db.Decimal(10, 2)
  homeWarranty    Decimal? @db.Decimal(10, 2)
  kwCares         Decimal? @db.Decimal(10, 2)
  kwNextGen       Decimal? @db.Decimal(10, 2)
  boldScholarship Decimal? @db.Decimal(10, 2)
  tcConcierge     Decimal? @db.Decimal(10, 2)
  jelmbergTeam    Decimal? @db.Decimal(10, 2)

  // BDH Specific
  bdhSplitPct       Decimal? @db.Decimal(5, 4)
  asf               Decimal? @db.Decimal(10, 2)
  foundation10      Decimal? @db.Decimal(10, 2)
  adminFee          Decimal? @db.Decimal(10, 2)
  preSplitDeduction Decimal? @db.Decimal(10, 2)
  brokerageSplit    Decimal? @db.Decimal(10, 2) // Pre-calculated brokerage portion from CSV

  // Universal
  otherDeductions  Decimal? @db.Decimal(10, 2)
  buyersAgentSplit Decimal? @db.Decimal(10, 2)
  assistantBonus   Decimal? @db.Decimal(10, 2) // FYI only

  // Google Sheets Sync
  googleSheetsId String? // Row ID for Google Sheets sync
  
  // Notes (can store CSV NCI for referral transactions as JSON: {"csvNci": value})
  notes String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  listingId String? @unique
  listing   Listing? @relation(name: "ListingTransaction", fields: [listingId], references: [id], onDelete: SetNull)

  // Relations
  emails EmailLog[]

  @@index([brokerage])
  @@index([clientType])
  @@index([transactionType])
  @@index([closingDate])
  @@index([status])
  @@index([clientEmail])
  @@map("transactions")
}

model ListingPipelineTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  type        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stages   ListingStageTemplate[]
  listings Listing[]            @relation("ListingToTemplate")

  @@map("listing_pipeline_templates")
}

model ListingStageTemplate {
  id                  String   @id @default(cuid())
  pipelineTemplateId  String
  key                 String
  name                String
  sequence            Int
  durationDays        Int?
  trigger             String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  pipelineTemplate ListingPipelineTemplate @relation(fields: [pipelineTemplateId], references: [id], onDelete: Cascade)
  tasks             ListingTaskTemplate[]
  stageInstances    ListingStageInstance[]

  @@map("listing_stage_templates")
  @@index([pipelineTemplateId])
}

model ListingTaskTemplate {
  id               String   @id @default(cuid())
  stageTemplateId  String
  name             String
  dueInDays        Int?
  autoRepeat       Boolean  @default(false)
  autoComplete     Boolean  @default(false)
  triggerOn        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  stageTemplate ListingStageTemplate @relation(fields: [stageTemplateId], references: [id], onDelete: Cascade)
  taskInstances ListingTaskInstance[]

  @@map("listing_task_templates")
  @@index([stageTemplateId])
}

model Listing {
  id                    String          @id @default(cuid())
  title                 String?
  status                ListingStatus   @default(DRAFT)
  pipelineTemplateId    String?
  currentStageKey       String?
  currentStageStartedAt DateTime?
  sellerId              String?
  buyerClientId         String?
  address               String?
  city                  String?
  state                 String?
  zipCode               String?
  listPrice             Decimal?        @db.Decimal(12, 2)
  targetListDate        DateTime?
  projectedCloseDate    DateTime?
  notes                 String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  pipelineTemplate ListingPipelineTemplate? @relation("ListingToTemplate", fields: [pipelineTemplateId], references: [id], onDelete: SetNull)
  seller           FarmContact?             @relation("ListingSeller", fields: [sellerId], references: [id], onDelete: SetNull)
  buyerClient      GeneralContact?          @relation("ListingBuyerClient", fields: [buyerClientId], references: [id], onDelete: SetNull)
  stageInstances   ListingStageInstance[]
  taskInstances    ListingTaskInstance[]
  transaction      Transaction?             @relation(name: "ListingTransaction")

  @@map("listings")
  @@index([pipelineTemplateId])
  @@index([sellerId])
  @@index([buyerClientId])
  @@index([status])
}

model ListingStageInstance {
  id               String             @id @default(cuid())
  listingId        String
  stageTemplateId  String?
  key              String?
  name             String?
  order            Int
  status           ListingStageStatus @default(PENDING)
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  listing       Listing               @relation(fields: [listingId], references: [id], onDelete: Cascade)
  stageTemplate ListingStageTemplate? @relation(fields: [stageTemplateId], references: [id], onDelete: SetNull)
  tasks         ListingTaskInstance[]

  @@map("listing_stage_instances")
  @@index([listingId])
  @@index([stageTemplateId])
  @@index([status])
}

model ListingTaskInstance {
  id              String   @id @default(cuid())
  listingId       String
  stageInstanceId String?
  taskTemplateId  String?
  name            String
  dueDate         DateTime?
  dueInDays       Int?
  completed       Boolean  @default(false)
  completedAt     DateTime?
  notes           String?
  autoRepeat      Boolean  @default(false)
  autoComplete    Boolean  @default(false)
  triggerOn       String?
  documentId      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  listing       Listing               @relation(fields: [listingId], references: [id], onDelete: Cascade)
  stageInstance ListingStageInstance? @relation(fields: [stageInstanceId], references: [id], onDelete: SetNull)
  taskTemplate  ListingTaskTemplate?  @relation(fields: [taskTemplateId], references: [id], onDelete: SetNull)
  document      Document?             @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@map("listing_task_instances")
  @@index([listingId])
  @@index([stageInstanceId])
  @@index([taskTemplateId])
  @@index([documentId])
  @@index([completed])
  @@index([dueDate])
}

enum ListingStatus {
  DRAFT
  ACTIVE
  UNDER_CONTRACT
  CLOSED
  CANCELLED
  ARCHIVED
}

enum ListingStageStatus {
  PENDING
  ACTIVE
  COMPLETED
  SKIPPED
}

// Email Log - Hybrid storage (metadata in DB, full content in Google Sheets)
model EmailLog {
  id              String   @id @default(cuid())
  gmailMessageId  String   @unique // Gmail message ID
  sheetLogId      String?  // Reference to Email_Log sheet row (for full content)
  transactionId   String?  // Linked transaction (optional)
  contactId       String?  // Linked contact (optional - using FarmContact for now)
  direction       String   // "sent" | "received"
  from            String   // Sender email
  to              String   // Recipient email(s)
  cc              String?  // CC recipients
  bcc             String?  // BCC recipients
  subject         String   // Email subject
  bodyPreview     String?  // First 200 chars of body (for quick preview)
  timestamp       DateTime // When email was sent/received
  hasAttachments  Boolean  @default(false)
  isStarred       Boolean  @default(false)
  isUnread        Boolean  @default(false)
  autoLinked      Boolean  @default(false) // True if auto-linked by email matching
  inReplyTo       String?  // Message ID of email being replied to
  threadId        String?  // Gmail thread ID
  labels          String[] // Gmail labels (stored as array)
  
  // Relations
  transaction     Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  contact         FarmContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([transactionId])
  @@index([contactId])
  @@index([timestamp])
  @@index([gmailMessageId])
  @@index([direction])
  @@map("email_logs")
}
