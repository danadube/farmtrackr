// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model FarmContact {
  id                 String   @id @default(cuid())
  firstName          String?
  lastName           String?
  organizationName   String? // For businesses, trusts, organizations (separate from farm)
  farm               String?
  mailingAddress     String?
  city               String?
  state              String?
  zipCode            String?
  email1             String?
  email2             String?
  phoneNumber1       String?
  phoneNumber2       String?
  phoneNumber3       String?
  phoneNumber4       String?
  phoneNumber5       String?
  phoneNumber6       String?
  siteMailingAddress String?
  siteCity           String?
  siteState          String?
  siteZipCode        String?
  website            String?
  notes              String?
  dateCreated        DateTime @default(now())
  dateModified       DateTime @updatedAt

  // Relations
  emails EmailLog[]

  @@map("farm_contacts")
}

model GeneralContact {
  id                 String   @id @default(cuid())
  firstName          String?
  lastName           String?
  organizationName   String? // For businesses
  tags               String[] // Multi-select tags (e.g., "buyer", "seller", "client", "realtor")
  mailingAddress     String?
  city               String?
  state              String?
  zipCode            String?
  email1             String?
  email2             String?
  phoneNumber1       String?
  phoneNumber2       String?
  phoneNumber3       String?
  phoneNumber4       String?
  phoneNumber5       String?
  phoneNumber6       String?
  siteMailingAddress String?
  siteCity           String?
  siteState          String?
  siteZipCode        String?
  website            String?
  notes              String?
  googleContactsId   String? // Google Contacts resource ID for syncing
  dateCreated        DateTime @default(now())
  dateModified       DateTime @updatedAt

  @@map("general_contacts")
}

model ImportTemplate {
  id           String   @id @default(cuid())
  name         String
  description  String?
  fieldMapping Json // Store field mapping as JSON
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("import_templates")
}

model LabelTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  template    Json // Store template configuration as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("label_templates")
}

model Document {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String? // Document type: 'template', 'contact', 'report', or null
  content     String? // Store document content as text
  fileUrl     String? // Store file URL if it's a file
  contactId   String? // Optional link to a contact
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("documents")
}

model LetterTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  content     String // Template content with variables like {{farm}}, {{contact_name}}
  variables   Json? // Available variables as JSON array
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("letter_templates")
}

enum SignatureType {
  SINCERELY
  BEST_REGARDS
  WARMEST_REGARDS
  THANK_YOU
  RESPECTFULLY
  CUSTOM
}

model Signature {
  id        String        @id @default(cuid())
  name      String // Display name for the signature
  type      SignatureType @default(CUSTOM)
  closing   String // Closing text (e.g., "Sincerely,")
  signature String // Signature line (e.g., "John Doe" or "FarmTrackr Team")
  isDefault Boolean       @default(false)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@map("signatures")
}

model Letterhead {
  id          String   @id @default(cuid())
  name        String // Display name for the letterhead
  description String? // Brief description
  headerHtml  String? // HTML content for header (logo, company name, address)
  headerText  String? // Plain text alternative for header
  footerHtml  String? // HTML content for footer (optional)
  footerText  String? // Plain text alternative for footer
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("letterheads")
}

model Transaction {
  id String @id @default(cuid())

  // Basic Info
  propertyType    String // 'Residential', 'Commercial', 'Land', etc.
  clientType      String // 'Buyer', 'Seller'
  transactionType String // 'Sale', 'Referral Out', 'Referral In'
  source          String? // Lead source
  address         String?
  city            String?
  listPrice       Decimal?  @db.Decimal(12, 2)
  closedPrice     Decimal?  @db.Decimal(12, 2)
  listDate        DateTime?
  closingDate     DateTime?
  status          String // 'Closed', 'Pending', 'Cancelled'
  
  // Email Linking (for auto-linking emails)
  clientEmail     String? // Primary email for auto-linking emails
  ccEmails        String[] // Additional emails to auto-link (stored as array)

  // Referral Fields
  referringAgent      String? // Name of agent referred to/from
  referralFeeReceived Decimal? @db.Decimal(10, 2)

  // Commission Fields
  brokerage      String // 'Keller Williams', 'BDH', etc.
  commissionPct  Decimal? @db.Decimal(5, 4) // As decimal (0.0300 = 3%)
  referralPct    Decimal? @db.Decimal(5, 4)
  referralDollar Decimal? @db.Decimal(10, 2)
  netVolume      Decimal? @db.Decimal(12, 2)

  // KW Specific
  eo              Decimal? @db.Decimal(10, 2)
  royalty         Decimal? @db.Decimal(10, 2)
  companyDollar   Decimal? @db.Decimal(10, 2)
  hoaTransfer     Decimal? @db.Decimal(10, 2)
  homeWarranty    Decimal? @db.Decimal(10, 2)
  kwCares         Decimal? @db.Decimal(10, 2)
  kwNextGen       Decimal? @db.Decimal(10, 2)
  boldScholarship Decimal? @db.Decimal(10, 2)
  tcConcierge     Decimal? @db.Decimal(10, 2)
  jelmbergTeam    Decimal? @db.Decimal(10, 2)

  // BDH Specific
  bdhSplitPct       Decimal? @db.Decimal(5, 4)
  asf               Decimal? @db.Decimal(10, 2)
  foundation10      Decimal? @db.Decimal(10, 2)
  adminFee          Decimal? @db.Decimal(10, 2)
  preSplitDeduction Decimal? @db.Decimal(10, 2)
  brokerageSplit    Decimal? @db.Decimal(10, 2) // Pre-calculated brokerage portion from CSV

  // Universal
  otherDeductions  Decimal? @db.Decimal(10, 2)
  buyersAgentSplit Decimal? @db.Decimal(10, 2)
  assistantBonus   Decimal? @db.Decimal(10, 2) // FYI only

  // Google Sheets Sync
  googleSheetsId String? // Row ID for Google Sheets sync
  
  // Notes (can store CSV NCI for referral transactions as JSON: {"csvNci": value})
  notes String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  emails EmailLog[]

  @@index([brokerage])
  @@index([clientType])
  @@index([transactionType])
  @@index([closingDate])
  @@index([status])
  @@index([clientEmail])
  @@map("transactions")
}

// Email Log - Hybrid storage (metadata in DB, full content in Google Sheets)
model EmailLog {
  id              String   @id @default(cuid())
  gmailMessageId  String   @unique // Gmail message ID
  sheetLogId      String?  // Reference to Email_Log sheet row (for full content)
  transactionId   String?  // Linked transaction (optional)
  contactId       String?  // Linked contact (optional - using FarmContact for now)
  direction       String   // "sent" | "received"
  from            String   // Sender email
  to              String   // Recipient email(s)
  cc              String?  // CC recipients
  bcc             String?  // BCC recipients
  subject         String   // Email subject
  bodyPreview     String?  // First 200 chars of body (for quick preview)
  timestamp       DateTime // When email was sent/received
  hasAttachments  Boolean  @default(false)
  isStarred       Boolean  @default(false)
  isUnread        Boolean  @default(false)
  autoLinked      Boolean  @default(false) // True if auto-linked by email matching
  inReplyTo       String?  // Message ID of email being replied to
  threadId        String?  // Gmail thread ID
  labels          String[] // Gmail labels (stored as array)
  
  // Relations
  transaction     Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  contact         FarmContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([transactionId])
  @@index([contactId])
  @@index([timestamp])
  @@index([gmailMessageId])
  @@index([direction])
  @@map("email_logs")
}
